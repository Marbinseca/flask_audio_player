{% extends "base.html" %} {% block title %}Inicio - Audio Flask Player{%
endblock %} {% block extra_head %}
<!-- Additional styles for index page -->
<style>
  .waveform-bg {
    background: linear-gradient(
      90deg,
      transparent,
      rgba(59, 130, 246, 0.1),
      transparent
    );
    background-size: 200% 100%;
    animation: wave 3s linear infinite;
  }

  @keyframes wave {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  .glow-effect {
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
  }

  .playing-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .scrollbar-thin::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  .scrollbar-thin::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb {
    background: rgba(59, 130, 246, 0.5);
    border-radius: 3px;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: rgba(59, 130, 246, 0.7);
  }

  .gradient-text {
    background: linear-gradient(90deg, #60a5fa, #8b5cf6, #ec4899);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
</style>
{% endblock %} {% block content %}
<div
  class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-180px)] overflow-y-auto"
>
  <!-- Left Column - Player & Controls -->
  <div class="lg:w-2/3 flex flex-col gap-6">
    <!-- Quick Stats Banner -->
    <div
      class="bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-4"
    >
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div
            class="p-3 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg"
          >
            <i class="fas fa-music text-white text-xl"></i>
          </div>
          <div>
            <h2 class="text-xl font-bold text-white">
              Bienvenido al Audio Player
            </h2>
            <p class="text-gray-400 text-sm">
              Reproduce audio de YouTube, Vimeo, Facebook y más
            </p>
          </div>
        </div>
        <div class="hidden md:flex items-center space-x-6">
          <div class="text-center">
            <div class="text-2xl font-bold text-white" id="totalTracks">0</div>
            <div class="text-xs text-gray-400">Canciones</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-400" id="totalDuration">
              0:00
            </div>
            <div class="text-xs text-gray-400">Duración total</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-400" id="cacheSize">
              0 MB
            </div>
            <div class="text-xs text-gray-400">En caché</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Player Card -->
    <div
      class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 flex-grow"
    >
      <div class="flex flex-col lg:flex-row gap-8 h-full">
        <!-- Album Art & Track Info -->
        <div class="lg:w-1/3 flex flex-col items-center lg:items-start">
          <div class="relative mb-6">
            <!-- Album Art Container -->
            <div
              id="albumArtContainer"
              class="w-48 h-48 lg:w-56 lg:h-56 rounded-xl overflow-hidden shadow-2xl glow-effect"
            >
              <img
                id="currentAlbumArt"
                src="{{ url_for('static', filename='icons/default-album.png') }}"
                alt="Album Art"
                class="w-full h-full object-cover"
              />
              <!-- Default album art overlay -->
              <div
                id="defaultAlbumOverlay"
                class="absolute inset-0 bg-gradient-to-br from-blue-900/30 to-purple-900/30 flex items-center justify-center"
              >
                <i class="fas fa-music text-white/50 text-6xl"></i>
              </div>
            </div>

            <!-- Playing Animation -->
            <div
              id="playingAnimation"
              class="hidden absolute -bottom-3 left-1/2 transform -translate-x-1/2"
            >
              <div class="flex items-end space-x-1 h-8">
                <div
                  class="w-1.5 bg-blue-400 rounded-full playing-pulse"
                  style="height: 8px"
                ></div>
                <div
                  class="w-1.5 bg-blue-500 rounded-full playing-pulse"
                  style="height: 12px"
                ></div>
                <div
                  class="w-1.5 bg-purple-500 rounded-full playing-pulse"
                  style="height: 16px"
                ></div>
                <div
                  class="w-1.5 bg-purple-600 rounded-full playing-pulse"
                  style="height: 20px"
                ></div>
                <div
                  class="w-1.5 bg-purple-500 rounded-full playing-pulse"
                  style="height: 16px"
                ></div>
                <div
                  class="w-1.5 bg-blue-500 rounded-full playing-pulse"
                  style="height: 12px"
                ></div>
                <div
                  class="w-1.5 bg-blue-400 rounded-full playing-pulse"
                  style="height: 8px"
                ></div>
              </div>
            </div>
          </div>

          <!-- Track Info -->
          <div class="text-center lg:text-left w-full">
            <h1
              id="currentTrackTitle"
              class="text-2xl font-bold text-white mb-2 truncate"
            >
              No hay pista seleccionada
            </h1>
            <p id="currentTrackArtist" class="text-lg text-gray-400 mb-1">
              Selecciona una canción para comenzar
            </p>
            <div
              class="flex items-center justify-center lg:justify-start space-x-3 text-sm text-gray-500"
            >
              <span id="currentTrackAlbum" class="truncate"
                >Álbum desconocido</span
              >
              <span>•</span>
              <span
                id="currentTrackPlatform"
                class="px-2 py-1 bg-gray-800 rounded"
                >Sin plataforma</span
              >
            </div>
          </div>

          <!-- Quality Badge -->
          <div class="mt-4">
            <div
              class="inline-flex items-center space-x-2 px-3 py-2 bg-gray-800 rounded-lg"
            >
              <i class="fas fa-wave-square text-blue-400"></i>
              <span class="text-sm font-medium text-gray-300">Calidad:</span>
              <span id="currentQuality" class="text-sm font-bold text-green-400"
                >192kbps</span
              >
            </div>
          </div>
        </div>

        <!-- Player Controls & Progress -->
        <div class="lg:w-2/3 flex flex-col justify-between">
          <!-- Progress Bar -->
          <div class="mb-8">
            <div
              class="flex items-center justify-between text-sm text-gray-500 mb-2"
            >
              <span id="currentTime">0:00</span>
              <span id="totalTime">0:00</span>
            </div>
            <div
              class="relative h-2 bg-gray-800 rounded-full overflow-hidden cursor-pointer"
              id="progressContainer"
            >
              <div
                id="progressBackground"
                class="absolute inset-0 waveform-bg"
              ></div>
              <div
                id="progressBar"
                class="absolute h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full"
                style="width: 0%"
              ></div>
              <div
                id="progressHandle"
                class="absolute w-4 h-4 bg-white rounded-full -top-1 -ml-2 cursor-grab active:cursor-grabbing shadow-lg transition-transform duration-150 hover:scale-110"
                style="left: 0%"
              ></div>
            </div>
          </div>

          <!-- Main Controls -->
          <div class="mb-8">
            <div class="flex items-center justify-center space-x-8">
              <!-- Shuffle Button -->
              <button
                id="shuffleBtn"
                class="p-3 text-gray-400 hover:text-white hover:bg-gray-800 rounded-full transition-all duration-200 group"
              >
                <i class="fas fa-random text-xl"></i>
                <div
                  class="absolute -top-2 -right-2 w-6 h-6 bg-blue-500 rounded-full hidden group-hover:flex items-center justify-center"
                >
                  <i class="fas fa-info text-xs text-white"></i>
                </div>
              </button>

              <!-- Previous Button -->
              <button
                id="prevBtn"
                class="p-4 text-gray-300 hover:text-white hover:bg-gray-800 rounded-full transition-all duration-200"
              >
                <i class="fas fa-step-backward text-2xl"></i>
              </button>

              <!-- Play/Pause Button -->
              <button
                id="playPauseBtn"
                class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-full flex items-center justify-center text-white transition-all duration-200 shadow-2xl hover:shadow-3xl transform hover:scale-105"
              >
                <i id="playPauseIcon" class="fas fa-play text-2xl"></i>
              </button>

              <!-- Next Button -->
              <button
                id="nextBtn"
                class="p-4 text-gray-300 hover:text-white hover:bg-gray-800 rounded-full transition-all duration-200"
              >
                <i class="fas fa-step-forward text-2xl"></i>
              </button>

              <!-- Repeat Button -->
              <button
                id="repeatBtn"
                class="p-3 text-gray-400 hover:text-white hover:bg-gray-800 rounded-full transition-all duration-200 group"
              >
                <i class="fas fa-redo text-xl"></i>
                <div
                  class="absolute -top-2 -right-2 w-6 h-6 bg-purple-500 rounded-full hidden group-hover:flex items-center justify-center"
                >
                  <i class="fas fa-info text-xs text-white"></i>
                </div>
              </button>
            </div>
          </div>

          <!-- Secondary Controls -->
          <div class="space-y-6">
            <!-- Volume Control -->
            <div class="flex items-center space-x-4">
              <button id="volumeMuteBtn" class="text-gray-400 hover:text-white">
                <i class="fas fa-volume-up text-lg"></i>
              </button>
              <div class="flex-grow relative">
                <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
                  <div
                    id="volumeBar"
                    class="h-full bg-gradient-to-r from-blue-400 to-blue-300 rounded-full"
                    style="width: 80%"
                  ></div>
                </div>
                <div
                  id="volumeHandle"
                  class="absolute w-4 h-4 bg-white rounded-full -top-1 -ml-2 cursor-pointer shadow"
                  style="left: 80%"
                ></div>
              </div>
              <span id="volumePercentage" class="text-sm text-gray-400 w-12"
                >80%</span
              >
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3">
              <button
                id="downloadBtn"
                class="flex-1 md:flex-none px-4 py-2.5 bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600 text-gray-300 rounded-lg transition-all duration-200 flex items-center justify-center space-x-2"
              >
                <i class="fas fa-download"></i>
                <span>Descargar</span>
              </button>

              <button
                id="favoriteBtn"
                class="flex-1 md:flex-none px-4 py-2.5 bg-gradient-to-r from-gray-800 to-gray-700 hover:from-pink-700 hover:to-pink-600 text-gray-300 hover:text-white rounded-lg transition-all duration-200 flex items-center justify-center space-x-2"
              >
                <i class="far fa-heart"></i>
                <span>Favorito</span>
              </button>

              <button
                id="shareBtn"
                class="flex-1 md:flex-none px-4 py-2.5 bg-gradient-to-r from-gray-800 to-gray-700 hover:from-green-700 hover:to-green-600 text-gray-300 hover:text-white rounded-lg transition-all duration-200 flex items-center justify-center space-x-2"
              >
                <i class="fas fa-share-alt"></i>
                <span>Compartir</span>
              </button>

              <button
                id="queueBtn"
                class="flex-1 md:flex-none px-4 py-2.5 bg-gradient-to-r from-gray-800 to-gray-700 hover:from-blue-700 hover:to-blue-600 text-gray-300 hover:text-white rounded-lg transition-all duration-200 flex items-center justify-center space-x-2"
              >
                <i class="fas fa-list-ol"></i>
                <span>Cola</span>
                <span
                  id="queueCount"
                  class="ml-1 px-2 py-0.5 bg-blue-500 text-xs rounded-full"
                  >0</span
                >
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Column - Quick Add & Playlist -->
  <div class="lg:w-1/3 flex flex-col gap-6">
    <!-- Quick Add URL Card -->
    <div
      class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-5"
    >
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-white">
          <i class="fas fa-plus-circle text-blue-400 mr-2"></i>
          Agregar Audio Rápido
        </h3>
        <button id="showAddModalBtn" class="text-gray-400 hover:text-white">
          <i class="fas fa-expand-arrows-alt"></i>
        </button>
      </div>

      <!-- URL Input -->
      <div class="mb-4">
        <div class="relative">
          <input
            type="text"
            id="quickUrlInput"
            placeholder="Pega URL de YouTube, Vimeo, etc..."
            class="w-full px-4 py-3 pr-10 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <button
            id="quickPasteBtn"
            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white"
          >
            <i class="fas fa-paste"></i>
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-2">
          Soporta: YouTube, Vimeo, Facebook, SoundCloud, Spotify
        </p>
      </div>

      <!-- Platform Quick Buttons -->
      <div class="mb-4">
        <div class="grid grid-cols-4 gap-2">
          <button
            data-platform="youtube"
            class="quick-platform-btn p-2 bg-gray-700 hover:bg-red-600 rounded-lg transition-colors duration-200"
          >
            <i class="fab fa-youtube text-red-500"></i>
            <span class="text-xs mt-1">YouTube</span>
          </button>
          <button
            data-platform="vimeo"
            class="quick-platform-btn p-2 bg-gray-700 hover:bg-blue-600 rounded-lg transition-colors duration-200"
          >
            <i class="fab fa-vimeo-v text-blue-500"></i>
            <span class="text-xs mt-1">Vimeo</span>
          </button>
          <button
            data-platform="facebook"
            class="quick-platform-btn p-2 bg-gray-700 hover:bg-blue-700 rounded-lg transition-colors duration-200"
          >
            <i class="fab fa-facebook text-blue-700"></i>
            <span class="text-xs mt-1">Facebook</span>
          </button>
          <button
            data-platform="soundcloud"
            class="quick-platform-btn p-2 bg-gray-700 hover:bg-orange-600 rounded-lg transition-colors duration-200"
          >
            <i class="fab fa-soundcloud text-orange-500"></i>
            <span class="text-xs mt-1">SoundCloud</span>
          </button>
        </div>
      </div>

      <!-- Quick Add Button -->
      <button
        id="quickAddBtn"
        class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white rounded-lg transition-all duration-200 flex items-center justify-center space-x-2"
      >
        <i class="fas fa-plus"></i>
        <span>Agregar y Reproducir</span>
      </button>
    </div>

    <!-- Now Playing & Up Next -->
    <div
      class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-5 flex-grow"
    >
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-white">
          <i class="fas fa-play-circle text-green-400 mr-2"></i>
          Reproduciendo Ahora
        </h3>
        <div class="flex items-center space-x-2">
          <span
            id="playlistStatus"
            class="text-xs px-2 py-1 bg-gray-800 rounded"
            >0 canciones</span
          >
        </div>
      </div>

      <!-- Now Playing Card -->
      <div
        id="nowPlayingCard"
        class="bg-gradient-to-r from-gray-700 to-gray-800 border border-gray-600 rounded-lg p-4 mb-4 hidden"
      >
        <div class="flex items-center space-x-3">
          <div class="relative">
            <img
              id="nowPlayingArt"
              src=""
              alt=""
              class="w-12 h-12 rounded-lg object-cover"
            />
            <div
              class="absolute inset-0 bg-gradient-to-br from-blue-500/20 to-purple-600/20 rounded-lg"
            ></div>
          </div>
          <div class="flex-grow min-w-0">
            <h4
              id="nowPlayingTitle"
              class="text-sm font-semibold text-white truncate"
            ></h4>
            <p id="nowPlayingArtist" class="text-xs text-gray-400 truncate"></p>
            <div class="flex items-center space-x-2 mt-1">
              <span id="nowPlayingTime" class="text-xs text-gray-500"></span>
              <span
                id="nowPlayingPlatformBadge"
                class="text-xs px-1.5 py-0.5 bg-gray-800 rounded"
              ></span>
            </div>
          </div>
          <button
            id="nowPlayingPlayBtn"
            class="p-2 text-white hover:text-blue-400 transition-colors duration-200"
          >
            <i class="fas fa-play text-xl"></i>
          </button>
          <div id="nowPlayingAnimation" class="hidden">
            <div class="flex items-end space-x-0.5 h-6">
              <div
                class="w-1 bg-blue-400 rounded-full playing-pulse"
                style="height: 6px"
              ></div>
              <div
                class="w-1 bg-blue-500 rounded-full playing-pulse"
                style="height: 9px"
              ></div>
              <div
                class="w-1 bg-purple-500 rounded-full playing-pulse"
                style="height: 12px"
              ></div>
              <div
                class="w-1 bg-purple-500 rounded-full playing-pulse"
                style="height: 12px"
              ></div>
              <div
                class="w-1 bg-blue-500 rounded-full playing-pulse"
                style="height: 9px"
              ></div>
              <div
                class="w-1 bg-blue-400 rounded-full playing-pulse"
                style="height: 6px"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Playlist Header -->
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-sm font-medium text-gray-300">
          <i class="fas fa-list-ul text-blue-400 mr-2"></i>
          Lista de Reproducción
        </h4>
        <div class="flex items-center space-x-2">
          <button
            id="clearPlaylistBtn"
            class="text-xs text-gray-400 hover:text-red-400"
          >
            <i class="fas fa-trash-alt mr-1"></i>
            Limpiar
          </button>
          <button
            id="savePlaylistBtn"
            class="text-xs text-gray-400 hover:text-green-400"
          >
            <i class="fas fa-save mr-1"></i>
            Guardar
          </button>
        </div>
      </div>

      <!-- Playlist Container -->
      <div id="playlistContainer" class="h-64 overflow-y-auto scrollbar-thin">
        <div
          id="emptyPlaylistMessage"
          class="flex flex-col items-center justify-center h-full text-center p-8"
        >
          <i class="fas fa-music text-gray-600 text-4xl mb-4"></i>
          <p class="text-gray-500 mb-2">La lista de reproducción está vacía</p>
          <p class="text-sm text-gray-600">
            Agrega URLs usando el campo de arriba
          </p>
        </div>

        <!-- Playlist items will be dynamically inserted here -->
        <div id="playlistItems" class="space-y-2"></div>
      </div>

      <!-- Playlist Controls -->
      <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-gray-700">
        <button
          id="shufflePlaylistBtn"
          class="flex-1 px-3 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors duration-200 text-sm"
        >
          <i class="fas fa-random mr-2"></i>
          Mezclar
        </button>
        <button
          id="exportPlaylistBtn"
          class="flex-1 px-3 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors duration-200 text-sm"
        >
          <i class="fas fa-file-export mr-2"></i>
          Exportar
        </button>
        <button
          id="importPlaylistBtn"
          class="flex-1 px-3 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors duration-200 text-sm"
        >
          <i class="fas fa-file-import mr-2"></i>
          Importar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Include Add URL Modal -->
{% include 'add_url_modal.html' %}

<!-- Settings Modal -->
<div
  id="settingsModal"
  class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full z-50"
>
  <div
    class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-lg bg-gradient-to-br from-gray-800 to-gray-900"
  >
    {% include 'settings_modal.html' %}
  </div>
</div>

<!-- Quick Actions Menu -->
<div
  id="quickActionsMenu"
  class="hidden fixed bottom-24 right-6 bg-gray-800 border border-gray-700 rounded-lg shadow-xl py-2 z-40 w-48"
>
  <a
    href="#"
    class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 transition-colors duration-150"
  >
    <i class="fas fa-plus mr-2"></i>Nueva Lista
  </a>
  <a
    href="#"
    class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 transition-colors duration-150"
  >
    <i class="fas fa-download mr-2"></i>Descargar Todo
  </a>
  <a
    href="#"
    id="openSettingsBtn"
    class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 transition-colors duration-150"
  >
    <i class="fas fa-sliders-h mr-2"></i>Ajustes Avanzados
  </a>
  <div class="border-t border-gray-700 my-1"></div>
  <a
    href="#"
    class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 transition-colors duration-150"
  >
    <i class="fas fa-question-circle mr-2"></i>Ayuda
  </a>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  // Index page specific JavaScript
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize quick add functionality
    initQuickAdd();

    // Initialize playlist display
    loadPlaylist();

    // Initialize player controls
    initPlayerControls();

    // Initialize player instance
    window.AppState.player = new AudioPlayer();
    setupPlayerListeners();

    // Update stats
    updateStats();

    // Initialize settings
    initSettings();

    // Initialize Add URL Modal
    initAddUrlModal();
  });

  function initAddUrlModal() {
    const modal = document.getElementById("addUrlModal");
    const closeBtn = document.getElementById("closeModalBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const addBtn = document.getElementById("addBtn");
    const urlInput = document.getElementById("urlInput");
    const pasteBtn = document.getElementById("pasteBtn");
    const platformBtns = document.querySelectorAll(
      "#addUrlModal .platform-btn"
    );
    const autoPlayCheckbox = document.getElementById("autoPlayCheckbox");

    // Helper to close modal
    const closeModal = () => {
      modal.classList.add("hidden");
      urlInput.value = ""; // Reset input
    };

    // Close events
    closeBtn?.addEventListener("click", closeModal);
    cancelBtn?.addEventListener("click", closeModal);
    modal?.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    // Paste button
    pasteBtn?.addEventListener("click", async () => {
      try {
        const text = await navigator.clipboard.readText();
        urlInput.value = text;
      } catch (err) {
        console.error("Clipboard access failed", err);
        // Fallback or ignore
      }
    });

    // Platform selection shortcuts
    platformBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const platform = btn.dataset.platform;
        let template = "";
        switch (platform) {
          case "youtube":
            template = "https://www.youtube.com/watch?v=";
            break;
          case "vimeo":
            template = "https://vimeo.com/";
            break;
          case "facebook":
            template = "https://www.facebook.com/watch/?v=";
            break;
          case "soundcloud":
            template = "https://soundcloud.com/";
            break;
        }
        urlInput.value = template;
        urlInput.focus();
      });
    });

    // Add button logic
    addBtn?.addEventListener("click", () => {
      const url = urlInput.value.trim();
      if (!url) {
        showToast("Por favor ingresa una URL", "warning");
        return;
      }

      // Check autoplay setting
      const autoPlay = autoPlayCheckbox ? autoPlayCheckbox.checked : false;

      // Call main add function
      addTrackFromUrl(url, autoPlay);

      // Close modal
      closeModal();
    });
  }

  function initQuickAdd() {
    const quickUrlInput = document.getElementById("quickUrlInput");
    const quickPasteBtn = document.getElementById("quickPasteBtn");
    const quickAddBtn = document.getElementById("quickAddBtn");
    const quickPlatformBtns = document.querySelectorAll(".quick-platform-btn");
    const showAddModalBtn = document.getElementById("showAddModalBtn");

    // Handle paste button
    quickPasteBtn.addEventListener("click", async () => {
      try {
        const text = await navigator.clipboard.readText();
        quickUrlInput.value = text;
        showToast("URL pegada del portapapeles", "success");
      } catch (err) {
        console.error("Failed to read clipboard:", err);
        showToast("Error al acceder al portapapeles", "error");
      }
    });

    // Handle quick add button
    quickAddBtn.addEventListener("click", () => {
      const url = quickUrlInput.value.trim();
      if (!url) {
        showToast("Por favor, ingresa una URL", "warning");
        quickUrlInput.focus();
        return;
      }

      addTrackFromUrl(url, true); // true = autoplay
      quickUrlInput.value = "";
    });

    // Handle platform quick buttons
    quickPlatformBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const platform = btn.dataset.platform;
        let url = "";

        switch (platform) {
          case "youtube":
            url = "https://www.youtube.com/watch?v=";
            break;
          case "vimeo":
            url = "https://vimeo.com/";
            break;
          case "facebook":
            url = "https://www.facebook.com/watch/?v=";
            break;
          case "soundcloud":
            url = "https://soundcloud.com/";
            break;
        }

        quickUrlInput.value = url;
        quickUrlInput.focus();
        showToast(`Plantilla de ${platform} agregada`, "info");
      });
    });

    // Show full add modal
    showAddModalBtn.addEventListener("click", () => {
      const modal = document.getElementById("addUrlModal");
      modal.classList.remove("hidden");
    });

    // Allow Enter key to add
    quickUrlInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        quickAddBtn.click();
      }
    });
  }

  function initPlayerControls() {
    const playPauseBtn = document.getElementById("playPauseBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const repeatBtn = document.getElementById("repeatBtn");
    const progressContainer = document.getElementById("progressContainer");
    const progressHandle = document.getElementById("progressHandle");
    const volumeBar = document.getElementById("volumeBar");
    const volumeHandle = document.getElementById("volumeHandle");
    const volumeMuteBtn = document.getElementById("volumeMuteBtn");

    // Play/Pause button
    playPauseBtn.addEventListener("click", () => {
      if (!window.AppState.currentTrack) {
        showToast("Selecciona una canción primero", "warning");
        return;
      }
      // Delegate to player instance
      window.AppState.player.togglePlay();

      // State update is handled by onPlayStateChange listener
      // Toast is handled by player state or can be added here if needed
      if (window.AppState.player.isPlaying) {
        showToast("Reproduciendo", "success");
      } else {
        showToast("Pausado", "info");
      }
    });

    // Previous button
    prevBtn.addEventListener("click", () => {
      fetch(APP_CONFIG.endpoints.previousTrack, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken(),
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success && data.track) {
            setCurrentTrack(data.track);
            window.AppState.player.loadTrack(data.track);
            showToast("Canción anterior", "info");
          }
        })
        .catch((error) => {
          console.error("Error getting previous track:", error);
        });
    });

    // Next button
    nextBtn.addEventListener("click", () => {
      fetch(APP_CONFIG.endpoints.nextTrack, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken(),
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success && data.track) {
            setCurrentTrack(data.track);
            window.AppState.player.loadTrack(data.track);
            showToast("Siguiente canción", "info");
          }
        })
        .catch((error) => {
          console.error("Error getting next track:", error);
        });
    });

    // Shuffle button
    shuffleBtn.addEventListener("click", () => {
      window.AppState.shuffle = !window.AppState.shuffle;
      shuffleBtn.classList.toggle("text-blue-400", window.AppState.shuffle);
      shuffleBtn.classList.toggle("text-gray-400", !window.AppState.shuffle);

      if (window.AppState.shuffle) {
        showToast("Modo mezcla activado", "success");
      } else {
        showToast("Modo mezcla desactivado", "info");
      }
    });

    // Repeat button
    repeatBtn.addEventListener("click", () => {
      window.AppState.repeat = !window.AppState.repeat;
      repeatBtn.classList.toggle("text-purple-400", window.AppState.repeat);
      repeatBtn.classList.toggle("text-gray-400", !window.AppState.repeat);

      if (window.AppState.repeat) {
        showToast("Repetición activada", "success");
      } else {
        showToast("Repetición desactivada", "info");
      }
    });

    // Progress bar interaction
    window.isDraggingProgress = false;

    progressContainer.addEventListener("mousedown", startDraggingProgress);
    progressHandle.addEventListener("mousedown", startDraggingProgress);

    function startDraggingProgress(e) {
      window.isDraggingProgress = true;
      document.addEventListener("mousemove", dragProgress);
      document.addEventListener("mouseup", stopDraggingProgress);
      updateProgress(e);
    }

    function dragProgress(e) {
      if (window.isDraggingProgress) {
        updateProgress(e);
      }
    }

    function stopDraggingProgress() {
      window.isDraggingProgress = false;
      document.removeEventListener("mousemove", dragProgress);
      document.removeEventListener("mouseup", stopDraggingProgress);
    }

    function updateProgress(e) {
      const rect = progressContainer.getBoundingClientRect();
      let x = e.clientX - rect.left;
      x = Math.max(0, Math.min(x, rect.width));
      const percentage = (x / rect.width) * 100;

      document.getElementById("progressBar").style.width = percentage + "%";
      document.getElementById("progressHandle").style.left = percentage + "%";

      // Seek in player
      if (
        window.AppState.player &&
        isFinite(window.AppState.player.getDuration())
      ) {
        const time = (percentage / 100) * window.AppState.player.getDuration();
        window.AppState.player.seek(time);
      }

      // Update time display (simplified - in real app, would calculate from track duration)
      if (
        window.AppState.currentTrack &&
        window.AppState.currentTrack.duration
      ) {
        const currentTime =
          (window.AppState.currentTrack.duration * percentage) / 100;
        document.getElementById("currentTime").textContent =
          formatTime(currentTime);
      }
    }

    // Volume control
    let isDraggingVolume = false;
    const volumeContainer = volumeBar.parentElement;

    volumeContainer.addEventListener("mousedown", startDraggingVolume);
    volumeHandle.addEventListener("mousedown", startDraggingVolume);

    function startDraggingVolume(e) {
      isDraggingVolume = true;
      document.addEventListener("mousemove", dragVolume);
      document.addEventListener("mouseup", stopDraggingVolume);
      updateVolume(e);
    }

    function dragVolume(e) {
      if (isDraggingVolume) {
        updateVolume(e);
      }
    }

    function stopDraggingVolume() {
      isDraggingVolume = false;
      document.removeEventListener("mousemove", dragVolume);
      document.removeEventListener("mouseup", stopDraggingVolume);
    }

    function updateVolume(e) {
      const rect = volumeContainer.getBoundingClientRect();
      let x = e.clientX - rect.left;
      x = Math.max(0, Math.min(x, rect.width));
      const percentage = (x / rect.width) * 100;

      volumeBar.style.width = percentage + "%";
      volumeHandle.style.left = percentage + "%";
      document.getElementById("volumePercentage").textContent =
        Math.round(percentage) + "%";

      window.AppState.volume = percentage / 100;
      if (window.AppState.player) {
        window.AppState.player.setVolume(window.AppState.volume);
      }
    }

    // Mute button
    let previousVolume = window.AppState.volume;
    volumeMuteBtn.addEventListener("click", () => {
      if (window.AppState.volume > 0) {
        previousVolume = window.AppState.volume;
        window.AppState.volume = 0;
        volumeBar.style.width = "0%";
        volumeHandle.style.left = "0%";
        document.getElementById("volumePercentage").textContent = "0%";
        volumeMuteBtn.innerHTML = '<i class="fas fa-volume-mute text-lg"></i>';
        if (window.AppState.player) window.AppState.player.setVolume(0);
        showToast("Silenciado", "info");
      } else {
        window.AppState.volume = previousVolume;
        const percentage = previousVolume * 100;
        volumeBar.style.width = percentage + "%";
        volumeHandle.style.left = percentage + "%";
        document.getElementById("volumePercentage").textContent =
          Math.round(percentage) + "%";
        volumeMuteBtn.innerHTML = '<i class="fas fa-volume-up text-lg"></i>';
        if (window.AppState.player)
          window.AppState.player.setVolume(previousVolume);
        showToast("Sonido restaurado", "success");
      }
    });
  }

  function updatePlayPauseState() {
    const playPauseIcon = document.getElementById("playPauseIcon");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const playingAnimation = document.getElementById("playingAnimation");
    const nowPlayingAnimation = document.getElementById("nowPlayingAnimation");

    const nowPlayingBtn = document.getElementById("nowPlayingPlayBtn");
    const nowPlayingIcon = nowPlayingBtn?.querySelector("i");

    if (window.AppState.isPlaying) {
      playPauseIcon.classList.remove("fa-play");
      playPauseIcon.classList.add("fa-pause");
      playPauseBtn.classList.add("glow-effect");
      playingAnimation.classList.remove("hidden");
      if (nowPlayingAnimation) nowPlayingAnimation.classList.remove("hidden");

      if (nowPlayingIcon) {
        nowPlayingIcon.classList.remove("fa-play");
        nowPlayingIcon.classList.add("fa-pause");
      }
    } else {
      playPauseIcon.classList.remove("fa-pause");
      playPauseIcon.classList.add("fa-play");
      playPauseBtn.classList.remove("glow-effect");
      playingAnimation.classList.add("hidden");
      if (nowPlayingAnimation) nowPlayingAnimation.classList.add("hidden");

      if (nowPlayingIcon) {
        nowPlayingIcon.classList.remove("fa-pause");
        nowPlayingIcon.classList.add("fa-play");
      }
    }
  }

  function setCurrentTrack(track) {
    window.AppState.currentTrack = track;

    // Update main player display
    document.getElementById("currentTrackTitle").textContent =
      track.title || "Sin título";
    document.getElementById("currentTrackArtist").textContent =
      track.artist || "Artista desconocido";
    document.getElementById("currentTrackAlbum").textContent =
      track.album || "Álbum desconocido";
    document.getElementById("currentTrackPlatform").textContent =
      track.platform || "Desconocido";
    document.getElementById(
      "currentTrackPlatform"
    ).className = `px-2 py-1 ${getPlatformColor(track.platform)} rounded`;

    document.getElementById("totalTime").textContent = formatTime(
      track.duration || 0
    );
    document.getElementById(
      "currentQuality"
    ).textContent = `${window.AppState.settings.quality}kbps`;

    // Update album art
    const albumArt = document.getElementById("currentAlbumArt");
    const defaultOverlay = document.getElementById("defaultAlbumOverlay");
    if (track.thumbnail) {
      albumArt.src = track.thumbnail;
      defaultOverlay.classList.add("hidden");
    } else {
      albumArt.src = APP_CONFIG.defaultThumbnail;
      defaultOverlay.classList.remove("hidden");
    }

    // Update now playing card
    const nowPlayingCard = document.getElementById("nowPlayingCard");
    if (track) {
      nowPlayingCard.classList.remove("hidden");
      document.getElementById("nowPlayingTitle").textContent = track.title;
      document.getElementById("nowPlayingArtist").textContent = track.artist;
      document.getElementById("nowPlayingTime").textContent = formatTime(
        track.duration
      );
      document.getElementById("nowPlayingPlatformBadge").textContent =
        track.platform;
      document.getElementById(
        "nowPlayingPlatformBadge"
      ).className = `text-xs px-1.5 py-0.5 ${getPlatformColor(
        track.platform
      )} rounded`;

      if (track.thumbnail) {
        document.getElementById("nowPlayingArt").src = track.thumbnail;
      }
    } else {
      nowPlayingCard.classList.add("hidden");
    }

    // Auto-play if setting is enabled
    if (window.AppState.settings.autoplay) {
      window.AppState.isPlaying = true;
      updatePlayPauseState();
    }
  }

  function getPlatformColor(platform) {
    const colors = {
      youtube: "bg-red-900 text-red-300",
      vimeo: "bg-blue-900 text-blue-300",
      facebook: "bg-blue-800 text-blue-200",
      soundcloud: "bg-orange-900 text-orange-300",
      spotify: "bg-green-900 text-green-300",
      default: "bg-gray-800 text-gray-300",
    };
    return colors[platform] || colors.default;
  }

  async function addTrackFromUrl(url, autoplay = false) {
    showToast("Procesando URL...", "info");

    try {
      const response = await apiFetch(APP_CONFIG.endpoints.addToPlaylist, {
        method: "POST",
        body: JSON.stringify({ url: url }),
      });

      if (response.success) {
        if (response.tracks) {
          // Multiple tracks (playlist)
          showToast(`${response.tracks.length} canciones agregadas`, "success");
          response.tracks.forEach((track) => {
            addPlaylistItem(track);
          });
        } else if (response.track) {
          // Single track
          showToast("Canción agregada", "success");
          addPlaylistItem(response.track);

          if (autoplay) {
            // Set as current track and play
            setCurrentTrack(response.track);
            window.AppState.player.loadTrack(response.track);
          }
        }

        // Update playlist display
        updatePlaylistDisplay();
        updateStats();
      } else {
        showToast(response.error || "Error al agregar canción", "error");
      }
    } catch (error) {
      console.error("Error adding track:", error);
      showToast("Error de conexión", "error");
    }
  }

  function addPlaylistItem(track) {
    const playlistItems = document.getElementById("playlistItems");
    const emptyMessage = document.getElementById("emptyPlaylistMessage");

    if (emptyMessage) {
      emptyMessage.classList.add("hidden");
    }

    const item = document.createElement("div");
    item.className =
      "playlist-item bg-gray-800 hover:bg-gray-700 rounded-lg p-3 cursor-pointer transition-colors duration-200 border border-gray-700";
    item.dataset.trackId = track.id;

    item.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="relative flex-shrink-0">
                    <img src="${
                      track.thumbnail || APP_CONFIG.defaultThumbnail
                    }" 
                         alt="${track.title}" 
                         class="w-10 h-10 rounded object-cover">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-500/20 to-purple-600/20 rounded"></div>
                </div>
                <div class="flex-grow min-w-0">
                    <h5 class="text-sm font-medium text-white truncate">${
                      track.title
                    }</h5>
                    <p class="text-xs text-gray-400 truncate">${
                      track.artist || "Artista desconocido"
                    }</p>
                    <div class="flex items-center space-x-2 mt-1">
                        <span class="text-xs text-gray-500">${formatTime(
                          track.duration || 0
                        )}</span>
                        <span class="text-xs px-1.5 py-0.5 ${getPlatformColor(
                          track.platform
                        )} rounded">${track.platform}</span>
                    </div>
                </div>
                <div class="flex items-center space-x-1">
                    <button class="play-track-btn p-1.5 text-gray-400 hover:text-white">
                        <i class="fas fa-play text-xs"></i>
                    </button>
                    <button class="remove-track-btn p-1.5 text-gray-400 hover:text-red-400">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            </div>
        `;

    // Add event listeners
    item.querySelector(".play-track-btn").addEventListener("click", (e) => {
      e.stopPropagation();
      playTrack(track.id);
    });

    item.querySelector(".remove-track-btn").addEventListener("click", (e) => {
      e.stopPropagation();
      removeTrack(track.id);
    });

    item.addEventListener("click", () => {
      playTrack(track.id);
    });

    playlistItems.appendChild(item);
  }

  function updatePlaylistDisplay() {
    const playlistContainer = document.getElementById("playlistContainer");
    const queueCount = document.getElementById("queueCount");
    const globalQueueCount = document.getElementById("globalQueueCount");
    const playlistStatus = document.getElementById("playlistStatus");

    const items = document.querySelectorAll(".playlist-item");
    const count = items.length;

    queueCount.textContent = count;
    if (globalQueueCount) globalQueueCount.textContent = count;
    playlistStatus.textContent = `${count} ${
      count === 1 ? "canción" : "canciones"
    }`;

    // Update empty state
    const emptyMessage = document.getElementById("emptyPlaylistMessage");
    if (count === 0 && emptyMessage) {
      emptyMessage.classList.remove("hidden");
    }
  }

  async function loadPlaylist() {
    try {
      const response = await apiFetch(APP_CONFIG.endpoints.playlist);

      if (response.success) {
        window.AppState.playlist = response.tracks || [];

        // Clear existing items
        const playlistItems = document.getElementById("playlistItems");
        playlistItems.innerHTML = "";

        // Add tracks
        response.tracks.forEach((track) => {
          addPlaylistItem(track);
        });

        // Update current track if available
        if (response.current_track) {
          setCurrentTrack(response.current_track);
        }

        updatePlaylistDisplay();
        updateStats();
      }
    } catch (error) {
      console.error("Error loading playlist:", error);
    }
  }

  async function playTrack(trackId) {
    try {
      const response = await apiFetch(APP_CONFIG.endpoints.currentTrack, {
        method: "POST",
        body: JSON.stringify({ track_id: trackId }),
      });

      if (response.success && response.track) {
        setCurrentTrack(response.track);
        window.AppState.player.loadTrack(response.track);
        showToast("Reproduciendo", "success");
      }
    } catch (error) {
      console.error("Error playing track:", error);
      showToast("Error al reproducir", "error");
    }
  }

  async function removeTrack(trackId) {
    try {
      const response = await apiFetch(`/api/playlist/remove/${trackId}`, {
        method: "DELETE",
      });

      if (response.success) {
        // Remove from DOM
        const item = document.querySelector(
          `.playlist-item[data-track-id="${trackId}"]`
        );
        if (item) {
          item.remove();
        }

        // Update playlist display
        updatePlaylistDisplay();
        updateStats();

        showToast("Canción eliminada", "success");
      }
    } catch (error) {
      console.error("Error removing track:", error);
      showToast("Error al eliminar", "error");
    }
  }

  function updateStats() {
    const totalTracks = document.getElementById("totalTracks");
    const totalDuration = document.getElementById("totalDuration");
    const cacheSize = document.getElementById("cacheSize");

    const tracks = window.AppState.playlist || [];
    totalTracks.textContent = tracks.length;

    // Calculate total duration
    const totalSeconds = tracks.reduce(
      (sum, track) => sum + (track.duration || 0),
      0
    );
    totalDuration.textContent = formatTime(totalSeconds);

    // Update cache size (placeholder - would need API endpoint)
    cacheSize.textContent = "0 MB";

    // Update global stats if API available
    fetch("/api/cache/info")
      .then((response) => response.json())
      .then((data) => {
        if (data.success && data.cache_info) {
          const sizeMB = data.cache_info.total_size_mb.toFixed(1);
          cacheSize.textContent = `${sizeMB} MB`;
        }
      })
      .catch(() => {
        // Silently fail
      });
  }

  // Initialize clear playlist button
  document.getElementById("clearPlaylistBtn")?.addEventListener("click", () => {
    if (
      confirm(
        "¿Estás seguro de que quieres limpiar toda la lista de reproducción?"
      )
    ) {
      apiFetch("/api/playlist/clear", {
        method: "DELETE",
      })
        .then((response) => {
          if (response.success) {
            // Clear UI
            const playlistItems = document.getElementById("playlistItems");
            playlistItems.innerHTML = "";

            // Reset state
            window.AppState.playlist = [];
            window.AppState.currentTrack = null;
            window.AppState.isPlaying = false;

            // Update displays
            updatePlaylistDisplay();
            updateStats();
            updatePlayPauseState();

            showToast("Lista limpiada", "success");
          }
        })
        .catch((error) => {
          console.error("Error clearing playlist:", error);
          showToast("Error al limpiar lista", "error");
        });
    }
  });

  // Initialize shuffle playlist button
  document
    .getElementById("shufflePlaylistBtn")
    ?.addEventListener("click", () => {
      apiFetch("/api/playlist/shuffle", {
        method: "POST",
      })
        .then((response) => {
          if (response.success) {
            showToast("Lista mezclada", "success");
            // Reload playlist to show new order
            loadPlaylist();
          }
        })
        .catch((error) => {
          console.error("Error shuffling playlist:", error);
          showToast("Error al mezclar lista", "error");
        });
    });

  function setupPlayerListeners() {
    if (!window.AppState.player) return;

    window.AppState.player.onTimeUpdate = (current, total) => {
      // Update time display
      document.getElementById("currentTime").textContent = formatTime(current);
      // Total time from player might be NaN initially
      if (total && !isNaN(total)) {
        // Only update total time if we don't have it from track info, or simply rely on track info usually
        // document.getElementById('totalTime').textContent = formatTime(total);
      }

      // Update progress bar width ONLY if not dragging
      if (!window.isDraggingProgress) {
        const progress = (current / total) * 100;
        if (!isNaN(progress)) {
          document.getElementById("progressBar").style.width = `${progress}%`;
          document.getElementById("progressHandle").style.left = `${progress}%`;
        }
      }
    };

    window.AppState.player.onTrackEnded = () => {
      // Auto play next track
      document.getElementById("nextBtn").click();
    };

    window.AppState.player.onPlayStateChange = (isPlaying) => {
      window.AppState.isPlaying = isPlaying;
      updatePlayPauseState();
    };
    // Now playing card play button
    document
      .getElementById("nowPlayingPlayBtn")
      ?.addEventListener("click", (e) => {
        e.stopPropagation();
        window.AppState.player.togglePlay();
      });

    window.AppState.player.onError = (msg) => {
      showToast(msg, "error");
    };
  }

  function initSettings() {
    const modal = document.getElementById("settingsModal");
    const openBtn = document.getElementById("openSettingsBtn");
    const closeBtn = document.getElementById("closeSettingsModalBtn");
    const cancelBtn = document.getElementById("cancelSettingsBtn");
    const saveBtn = document.getElementById("saveSettingsBtn");
    const clearCacheBtn = document.getElementById("clearCacheBtn");

    // Open modal
    openBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      loadSettings();
      modal.classList.remove("hidden");
      // Hide quick actions menu if open
      document.getElementById("quickActionsMenu").classList.add("hidden");
    });

    // Close modal functions
    const closeModal = () => modal.classList.add("hidden");
    closeBtn?.addEventListener("click", closeModal);
    cancelBtn?.addEventListener("click", closeModal);

    // Close on click outside
    modal?.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    // Save settings
    saveBtn?.addEventListener("click", async () => {
      const settings = {
        quality:
          document.querySelector('input[name="settings_quality"]:checked')
            ?.value || "192",
        autoplay: document.getElementById("settingAutoplay").checked,
        notifications: document.getElementById("settingNotifications").checked,
        theme: document.getElementById("settingTheme").checked
          ? "dark"
          : "light",
        default_platform: document.getElementById("settingPlatform").value,
      };

      try {
        const response = await apiFetch("/api/settings", {
          method: "POST",
          body: JSON.stringify(settings),
        });

        if (response.success) {
          window.AppState.settings = response.settings;
          showToast("Configuración guardada", "success");
          closeModal();

          // Apply immediate effects
          if (window.AppState.settings.quality) {
            const qualityDisplay = document.getElementById("currentQuality");
            if (qualityDisplay)
              qualityDisplay.textContent = `${window.AppState.settings.quality}kbps`;
          }
        }
      } catch (error) {
        console.error("Error saving settings:", error);
        showToast("Error al guardar configuración", "error");
      }
    });

    // Clear cache
    clearCacheBtn?.addEventListener("click", async () => {
      if (
        !confirm(
          "¿Seguro que deseas limpiar el caché de audio? Se eliminarán los archivos descargados."
        )
      )
        return;

      try {
        const response = await apiFetch("/api/cache/clear", { method: "POST" });
        if (response.success) {
          showToast(response.message, "success");
          loadCacheInfo();
        }
      } catch (error) {
        console.error("Error clearing cache:", error);
        showToast("Error al limpiar caché", "error");
      }
    });
  }

  async function loadSettings() {
    try {
      const response = await apiFetch("/api/settings");
      if (response.success) {
        const s = response.settings;

        // Set quality radio
        const qualityRadio = document.querySelector(
          `input[name="settings_quality"][value="${s.quality}"]`
        );
        if (qualityRadio) {
          qualityRadio.checked = true;
          // Trigger input change to update styles if needed (peer-checked handles it css-side)
        }

        // Set checkboxes
        const autoplayCheck = document.getElementById("settingAutoplay");
        if (autoplayCheck) autoplayCheck.checked = s.autoplay;

        const notifCheck = document.getElementById("settingNotifications");
        if (notifCheck) notifCheck.checked = s.notifications;

        const themeCheck = document.getElementById("settingTheme");
        if (themeCheck) themeCheck.checked = s.theme === "dark";

        // Set platform select
        const platformSelect = document.getElementById("settingPlatform");
        if (platformSelect)
          platformSelect.value = s.default_platform || "youtube";

        // Load cache info
        loadCacheInfo();
      }
    } catch (error) {
      console.error("Error loading settings:", error);
      showToast("Error al cargar configuración", "error");
    }
  }

  async function loadCacheInfo() {
    try {
      const response = await apiFetch("/api/cache/info");
      if (response.success && response.cache_info) {
        const sizeEl = document.getElementById("settingsCacheSize");
        const countEl = document.getElementById("settingsCacheCount");

        if (sizeEl)
          sizeEl.textContent = `${response.cache_info.total_size_mb.toFixed(
            1
          )} MB`;
        if (countEl)
          countEl.textContent = `${response.cache_info.file_count} archivos`;
      }
    } catch (error) {
      console.error("Error loading cache info:", error);
    }
  }
</script>
{% endblock %}
